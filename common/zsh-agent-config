#!/bin/zsh
# ZSH Configuration for AI Agent Mode (Cursor, GitHub Copilot, etc.)
# Optimized for compatibility and minimal interference with AI tools

ZSH=$DOTFILES/zsh/oh-my-zsh

# Load local setup if exists
if [ -f $DOTFILES/local/zsh-setup ]; then
	. $DOTFILES/local/zsh-setup
fi

# Basic SSH agent for servers
if [ "$is_server" = true ]; then
    eval $(ssh-agent)
    /usr/bin/ssh-add
fi
zstyle :omz:plugins:ssh-agent agent-forwarding on

# Disable auto-updates in agent mode
DISABLE_UPDATE_PROMPT=true
DISABLE_AUTO_UPDATE=true

# Use simple theme for better agent compatibility
ZSH_THEME="robbyrussell"  # Simple, clean theme

export LS_OPTIONS='--color=auto'
COMPLETION_WAITING_DOTS="false"  # Disable for cleaner output

# GitHub Copilot optimization settings
export COPILOT_DISABLE_TELEMETRY=true  # Optional: disable telemetry
export GITHUB_COPILOT_DISABLE_ANALYTICS=true  # Optional: disable analytics

# Load local config if exists
if [ -f $DOTFILES/local/zsh-config ]; then
	. $DOTFILES/local/zsh-config
fi

# Minimal plugin set for agent mode - only essentials
plugins=(git gitfast ssh-agent last-working-dir z)

# Add completions
fpath=($DOTFILES/zsh-completions/src $fpath)

# Load Oh My Zsh
if [ -f $ZSH/oh-my-zsh.sh ]; then
    source $ZSH/oh-my-zsh.sh
fi

export EDITOR=vim

# Set agent mode indicator
export AI_AGENT_MODE=1

# Load GitHub Copilot integration
if [ -f $DOTFILES/common/copilot-integration.zsh ]; then
    . $DOTFILES/common/copilot-integration.zsh
fi

# VS Code and AI Editor optimizations (Windsurf, GitHub Copilot, Cursor)
if [[ -n "$WINDSURF_PID" ]] || [[ -n "$VSCODE_PID" ]] || [[ "$TERM_PROGRAM" == "vscode" ]] || [[ -n "$VSCODE_INJECTION" ]]; then
    export WINDSURF_CONTEXT=1
    export VSCODE_CONTEXT=1

    # Optimize for AI features (Copilot, Windsurf Cascade, etc.)
    export TERM_PROGRAM_VERSION="${TERM_PROGRAM_VERSION:-windsurf}"

    # Enable better command completion for AI
    setopt AUTO_MENU
    setopt COMPLETE_IN_WORD
    setopt ALWAYS_TO_END
    setopt MENU_COMPLETE  # Auto-select first completion for faster AI parsing

    # Reduce completion delay for faster AI interactions
    export KEYTIMEOUT=1

    # VS Code terminal integration
    if [[ "$TERM_PROGRAM" == "vscode" ]]; then
        # Enable VS Code's shell integration for better Copilot context
        export VSCODE_SHELL_INTEGRATION=1
        
        # Optimize for GitHub Copilot in VS Code terminal
        export GITHUB_COPILOT_TERMINAL=1
        
        # Better command output formatting for AI parsing
        export COLUMNS=${COLUMNS:-120}  # Consistent width for AI readability
        export LINES=${LINES:-30}       # Standard height
    fi

    # Enable history for better AI context
    setopt SHARE_HISTORY
    setopt HIST_VERIFY
    setopt HIST_IGNORE_ALL_DUPS
    setopt HIST_FIND_NO_DUPS

    # Windsurf PATH optimization (if windsurf CLI is available)
    if [[ -d "/Applications/Windsurf.app/Contents/Resources/app/bin" ]]; then
        export PATH="/Applications/Windsurf.app/Contents/Resources/app/bin:$PATH"
    fi
fi

# Simplified prompt for agent mode
PROMPT='%n@%m:%~$ '

# Disable fancy features that might interfere with agents
unsetopt PROMPT_SP
unsetopt PROMPT_CR
setopt PROMPT_PERCENT
setopt TRANSIENT_RPROMPT

# VS Code and AI Editor helper functions
if [[ -n "$WINDSURF_CONTEXT" ]] || [[ -n "$VSCODE_CONTEXT" ]]; then
    # Quick function to open current directory in Windsurf
    windsurf-here() {
        if command -v windsurf &> /dev/null; then
            windsurf "${1:-.}"
        else
            echo "Windsurf CLI not found. Install it from Windsurf ‚Üí Command Palette ‚Üí Install 'windsurf' command"
        fi
    }

    # VS Code helper function
    code-here() {
        if command -v code &> /dev/null; then
            code "${1:-.}"
        else
            echo "VS Code CLI not found. Install it from VS Code ‚Üí Command Palette ‚Üí Install 'code' command"
        fi
    }

    # GitHub Copilot helper functions
    copilot-status() {
        echo "ü§ñ GitHub Copilot Terminal Status:"
        echo "   GITHUB_COPILOT_TERMINAL: ${GITHUB_COPILOT_TERMINAL:-'not set'}"
        echo "   TERM_PROGRAM: ${TERM_PROGRAM:-'not set'}"
        echo "   VSCODE_SHELL_INTEGRATION: ${VSCODE_SHELL_INTEGRATION:-'not set'}"
        if command -v gh &> /dev/null; then
            echo "   ‚úÖ GitHub CLI available"
            if gh copilot --version &> /dev/null; then
                echo "   ‚úÖ GitHub Copilot CLI extension available"
            else
                echo "   ‚ùå GitHub Copilot CLI extension not found (run: gh extension install github/gh-copilot)"
            fi
        else
            echo "   ‚ùå GitHub CLI not found"
        fi
    }

    # Quick function to ask GitHub Copilot for help
    ask-copilot() {
        if command -v gh &> /dev/null && gh copilot --version &> /dev/null; then
            gh copilot suggest "$*"
        else
            echo "GitHub Copilot CLI not available. Install with: gh extension install github/gh-copilot"
        fi
    }

    # Function to explain a command using GitHub Copilot
    explain-cmd() {
        if command -v gh &> /dev/null && gh copilot --version &> /dev/null; then
            gh copilot explain "$*"
        else
            echo "GitHub Copilot CLI not available. Install with: gh extension install github/gh-copilot"
        fi
    }

    # Function to check AI agent detection
    ai-status() {
        echo "ü§ñ AI Terminal Optimization Status:"
        echo "   WINDSURF_PID: ${WINDSURF_PID:-'not set'}"
        echo "   VSCODE_PID: ${VSCODE_PID:-'not set'}"
        echo "   TERM_PROGRAM: ${TERM_PROGRAM:-'not set'}"
        echo "   AI_AGENT_CONTEXT: ${AI_AGENT_CONTEXT:-'not set'}"
        echo "   WINDSURF_CONTEXT: ${WINDSURF_CONTEXT:-'not set'}"
        echo "   VSCODE_CONTEXT: ${VSCODE_CONTEXT:-'not set'}"
        echo "   GITHUB_COPILOT_TERMINAL: ${GITHUB_COPILOT_TERMINAL:-'not set'}"
        echo "   Active plugins: ${plugins[@]}"
        
        if command -v windsurf &> /dev/null; then
            echo "   ‚úÖ Windsurf CLI available"
        else
            echo "   ‚ùå Windsurf CLI not found"
        fi
        
        if command -v code &> /dev/null; then
            echo "   ‚úÖ VS Code CLI available"
        else
            echo "   ‚ùå VS Code CLI not found"
        fi
        
        if command -v gh &> /dev/null; then
            echo "   ‚úÖ GitHub CLI available"
            if gh copilot --version &> /dev/null; then
                echo "   ‚úÖ GitHub Copilot CLI extension available"
            else
                echo "   ‚ùå GitHub Copilot CLI extension not found"
            fi
        else
            echo "   ‚ùå GitHub CLI not found"
        fi
    }
fi