#!/bin/zsh
# ZSH Configuration for AI Agent Mode (Cursor, GitHub Copilot, etc.)
# Optimized for compatibility and minimal interference with AI tools

ZSH=$DOTFILES/zsh/oh-my-zsh

# Load local setup if exists
if [ -f $DOTFILES/local/zsh-setup ]; then
	. $DOTFILES/local/zsh-setup
fi

# Basic SSH agent for servers
if [ "$is_server" = true ]; then
    eval $(ssh-agent)
    /usr/bin/ssh-add
fi
zstyle :omz:plugins:ssh-agent agent-forwarding on

# Disable auto-updates in agent mode
DISABLE_UPDATE_PROMPT=true
DISABLE_AUTO_UPDATE=true

# Use simple theme for better agent compatibility
ZSH_THEME="robbyrussell"  # Simple, clean theme

export LS_OPTIONS='--color=auto'
COMPLETION_WAITING_DOTS="false"  # Disable for cleaner output

# Load local config if exists
if [ -f $DOTFILES/local/zsh-config ]; then
	. $DOTFILES/local/zsh-config
fi

# Minimal plugin set for agent mode - only essentials
plugins=(git gitfast ssh-agent last-working-dir z)

# Add completions
fpath=($DOTFILES/zsh-completions/src $fpath)

# Load Oh My Zsh
if [ -f $ZSH/oh-my-zsh.sh ]; then
    source $ZSH/oh-my-zsh.sh
fi

export EDITOR=vim

# Set agent mode indicator
export AI_AGENT_MODE=1

# Windsurf-specific optimizations
if [[ -n "$WINDSURF_PID" ]] || [[ -n "$VSCODE_PID" ]]; then
    export WINDSURF_CONTEXT=1

    # Optimize for Windsurf's Cascade AI features
    export TERM_PROGRAM_VERSION="${TERM_PROGRAM_VERSION:-windsurf}"

    # Enable better command completion for AI
    setopt AUTO_MENU
    setopt COMPLETE_IN_WORD
    setopt ALWAYS_TO_END

    # Reduce completion delay for faster AI interactions
    export KEYTIMEOUT=1

    # Enable history for better AI context
    setopt SHARE_HISTORY
    setopt HIST_VERIFY
    setopt HIST_IGNORE_ALL_DUPS
    setopt HIST_FIND_NO_DUPS

    # Windsurf PATH optimization (if windsurf CLI is available)
    if [[ -d "/Applications/Windsurf.app/Contents/Resources/app/bin" ]]; then
        export PATH="/Applications/Windsurf.app/Contents/Resources/app/bin:$PATH"
    fi
fi

# Simplified prompt for agent mode
PROMPT='%n@%m:%~$ '

# Disable fancy features that might interfere with agents
unsetopt PROMPT_SP
unsetopt PROMPT_CR
setopt PROMPT_PERCENT
setopt TRANSIENT_RPROMPT

# Windsurf helper functions
if [[ -n "$WINDSURF_CONTEXT" ]]; then
    # Quick function to open current directory in Windsurf
    windsurf-here() {
        if command -v windsurf &> /dev/null; then
            windsurf "${1:-.}"
        else
            echo "Windsurf CLI not found. Install it from Windsurf ‚Üí Command Palette ‚Üí Install 'windsurf' command"
        fi
    }

    # Function to check AI agent detection
    windsurf-check() {
        echo "üå™Ô∏è  Windsurf Terminal Optimization Status:"
        echo "   WINDSURF_PID: ${WINDSURF_PID:-'not set'}"
        echo "   VSCODE_PID: ${VSCODE_PID:-'not set'}"
        echo "   AI_AGENT_CONTEXT: ${AI_AGENT_CONTEXT:-'not set'}"
        echo "   WINDSURF_CONTEXT: ${WINDSURF_CONTEXT:-'not set'}"
        echo "   Active plugins: ${plugins[@]}"
        if command -v windsurf &> /dev/null; then
            echo "   ‚úÖ Windsurf CLI available"
        else
            echo "   ‚ùå Windsurf CLI not found"
        fi
    }
fi